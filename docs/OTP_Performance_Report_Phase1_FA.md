# گزارش کارایی سرویس OTP – فاز ۱ (API تولید کد)

## خلاصه مدیریتی (Executive Summary)

این گزارش نتایج دو تست کارایی انجام‌شده روی **API تولید کد OTP (فاز ۱)** را مستند می‌کند:

- **تست A – کشف ظرفیت (VU-based Ramp-to-Break):** برای به‌دست‌آوردن *حداکثر توان خام سیستم*.
- **تست B – نرخ ثابت (Constant Arrival Rate):** برای بررسی اینکه سیستم آیا می‌تواند *یک نرخ مشخص (RPS)* را به‌صورت پایدار حفظ کند یا خیر.

### جمع‌بندی کلان
- سیستم در تست VU-based به **حداکثر توان حدود ۱۹٬۵۰۰ درخواست بر ثانیه** با **۰٪ خطا** رسید، اما با افزایش محسوس latency در tail (p95≈199ms) و مصرف **۱۰۰٪ CPU**.
- در تست نرخ ثابت با هدف **۱۶٬۰۰۰ RPS**، سیستم حدود **۱۵٬۹۶۰ RPS** را با **latency بسیار عالی** و **۰٪ خطا** ارائه داد، اما مقدار کمی **dropped iterations (~0.21%)** مشاهده شد، در حالی که CPU بین **۸۰ تا ۹۵٪** نوسان داشت.

---

## مشخصات سیستم تحت تست (SUT)

### Endpoint
- **Method:** `POST`
- **Path:** `/v1/otp/code`
- **عملکرد:** تولید یک کد OTP عددی ۶ رقمی و بازگرداندن آن در response

### محیط اجرا
- سرویس و k6 روی **یک ماشین مشترک** اجرا شده‌اند.
- مصرف CPU:
  - تست A: حدود **۱۰۰٪ پایدار**
  - تست B: بین **۸۰ تا ۹۵٪**

> توجه: اجرای Load Generator و سرویس روی یک ماشین باعث **رقابت منابع** می‌شود؛ بنابراین اعداد به‌دست‌آمده سقف این setup مشترک هستند، نه سقف خالص خود سرویس.

---

## تست A — کشف ظرفیت (VU-based Ramp-to-Break)

### هدف تست
یافتن **حداکثر توان قابل دستیابی** سیستم با افزایش تدریجی concurrency تا رسیدن به نقطه اشباع.

### خلاصه نتایج
- کل درخواست‌ها: **4,203,155**
- Throughput: **≈ 19,549 req/s**
- خطا: **۰٪**
- Latency:
  - avg ≈ 63.8ms
  - p95 ≈ 199ms
  - p99 ≈ 345ms
- VUs:
  - حداکثر مشاهده‌شده: **~4,972**
- CPU: **≈100٪**

### تحلیل
- رسیدن به ~19.5k RPS نشان‌دهنده **سقف خام توان سیستم** در این setup است.
- افزایش p95/p99 در کنار CPU=100٪ نشانه‌ی **اشباع و تشکیل صف** است.
- بالا رفتن تعداد VUها به معنی نیاز k6 به concurrency بیشتر برای حفظ فشار، به‌دلیل افزایش زمان پاسخ‌هاست.

### نتیجه تست A
- **حداکثر توان خام:** ≈ **19.5k RPS**
- این عدد در شرایط اشباع به‌دست آمده و کیفیت latency در این نقطه بالا است.

---

## تست B — نرخ ثابت (Constant Arrival Rate با هدف 16k RPS)

### هدف تست
بررسی اینکه سیستم می‌تواند **نرخ ثابت ۱۶٬۰۰۰ RPS** را با کیفیت مناسب و بدون خطا حفظ کند یا خیر.

### خلاصه نتایج
- Target rate: **16,000 iters/s**
- Achieved rate: **≈ 15,962 iters/s**
- Dropped iterations: **4,110** (حدود **0.21٪**)
- خطا: **۰٪**
- Latency:
  - avg ≈ 3.8ms
  - p95 ≈ 19.7ms
  - p99 ≈ 43.2ms
- CPU: **۸۰–۹۵٪**

### تحلیل
- latency بسیار پایین و پایدار است؛ سرویس از نظر عملکرد داخلی مشکلی ندارد.
- dropped_iterations نشان می‌دهد k6 در برخی لحظات نتوانسته iterationها را دقیقاً طبق cadence شروع کند.
- دلیل اصلی: **نزدیک شدن به مرز منابع ماشین مشترک** (CPU contention)، نه ضعف خود سرویس.

### نتیجه تست B
- **نرخ پایدار تقریباً محقق‌شده:** ≈ **15.96k RPS**
- کیفیت عالی، خطای صفر، اما با drop جزئی که برای threshold سخت‌گیرانه `count==0` قابل قبول نیست.

---

## مقایسه نهایی دو تست

| شاخص | تست A (VU-based) | تست B (16k Constant Rate) |
|---|---:|---:|
| هدف | یافتن سقف خام | بررسی پایداری |
| Throughput | ~19.5k RPS | ~15.96k RPS |
| Error rate | 0٪ | 0٪ |
| p95 latency | ~199ms | ~19.7ms |
| CPU | ~100٪ | 80–95٪ |
| Dropped | — | ~0.21٪ |

---

## جمع‌بندی مهندسی

- **سقف خام توان سیستم:** حدود **۱۹.۵k RPS**
- **توان پایدار با کیفیت بالا:** حدود **۱۵–۱۶k RPS**
- اختلاف این دو عدد ناشی از:
  - اشباع CPU
  - رقابت منابع بین k6 و سرویس
  - سخت‌گیری scheduler در constant-arrival-rate

---

## پیشنهاد مراحل بعدی

1. تعیین رسمی SLO (مثلاً p95 < 50ms).
2. اجرای constant-arrival-rate در بازه 15k تا 16.5k برای یافتن عدد پایدار بدون drop.
3. اجرای k6 روی ماشین جداگانه برای حذف اثر رقابت منابع.
4. افزودن مانیتورینگ سمت سرور (CPU، GC، profiling).

---

## نتیجه نهایی قابل گزارش

> سرویس OTP (فاز ۱) در محیط فعلی توان دستیابی به حدود **۱۹٬۵۰۰ درخواست بر ثانیه** را دارد.  
> با درنظرگرفتن کیفیت پاسخ و پایداری، نرخ **۱۵٬۰۰۰ تا ۱۶٬۰۰۰ درخواست بر ثانیه** به‌عنوان ظرفیت عملی و قابل تعهد توصیه می‌شود.
